{% extends "base.html" %}

{% block title %}Payment Processing - World Cup Fan Zone{% endblock %}

{% block content %}
<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
    <!-- Immediate processing overlay if returning from Razorpay (run before heavy DOM paints) -->
    <script>
        (function(){
            try {
                var _rp_flag = null;
                try { _rp_flag = sessionStorage.getItem('payment_checkout_opened'); } catch(e) { _rp_flag = null; }
                if (_rp_flag && !document.getElementById('paymentProcessingOverlay')) {
                    var ol = document.createElement('div');
                    ol.id = 'paymentProcessingOverlay';
                    ol.className = 'rp-overlay';
                    ol.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
                    ol.innerHTML = '<div class="rp-card text-center rounded-lg p-4 bg-slate-900/70 backdrop-blur-sm">\n                            <div class="mb-4 flex h-20 w-20 items-center justify-center mx-auto">\n                                <div class="absolute inset-0 animate-spin rounded-full border-4 border-primary/30 border-t-primary"></div>\n                                <span class="material-symbols-outlined text-4xl text-primary animate-pulse">payments</span>\n                            </div>\n                            <p class="text-white text-lg font-semibold mb-1">Processing your payment...</p>\n                            <p class="text-blue-300 text-sm">Confirming with Razorpay â€” this should only take a moment.</p>\n                        </div>';
                        ol.innerHTML = '<div class="rp-card text-center rounded-lg p-4 bg-slate-900/70 backdrop-blur-sm">\n                            <div class="mb-4 flex h-20 w-20 items-center justify-center mx-auto">\n                                <span class="material-symbols-outlined text-4xl text-primary animate-pulse">payments</span>\n                            </div>\n                            <p class="text-white text-lg font-semibold mb-1">Processing your payment...</p>\n                            <p class="text-blue-300 text-sm">Confirming with Razorpay â€” this should only take a moment.</p>\n                        </div>';
                    try { document.documentElement.appendChild(ol); } catch(e) { try { document.body.appendChild(ol); } catch(e) {} }
                    setTimeout(function(){ try{ ol.classList.add('rp-visible'); }catch(e){} }, 20);
                }
            } catch(e) { /* silent */ }
        })();
    </script>

    <!-- Video Background -->
    <video autoplay loop muted playsinline preload="none" class="fixed top-0 left-0 w-full h-full object-cover z-0 opacity-15">
        <source src="https://cdn.jsdelivr.net/gh/NivedKris/cdn@main/background.mp4" type="video/mp4">
        <source src="{{ url_for('static', filename='video/background.mp4') }}" type="video/mp4">
    </video>

    <!-- Content Layer -->
    <div class="relative z-10">
    <div class="flex items-center bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm p-4 pb-2 justify-between">
        <a href="{{ url_for('dashboard') }}" class="text-slate-800 dark:text-white flex size-12 shrink-0 items-center">
            <span class="material-symbols-outlined text-2xl">arrow_back</span>
        </a>
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Complete Payment</h2>
        <div class="size-12 shrink-0"></div>
    </div>

    <div class="flex flex-col items-center justify-center flex-1 px-4 py-8 text-center">
        <div class="relative mb-8 flex h-40 w-40 items-center justify-center bg-primary/10 rounded-full">
            <span class="material-symbols-outlined text-7xl text-primary">payments</span>
        </div>
        
    <h1 class="text-white tracking-light text-[32px] font-bold leading-tight pb-3 pt-6">Pay with UPI (Google Pay)</h1>
        
        <p class="text-blue-200 text-base font-normal leading-normal pb-3 pt-1 max-w-md">
            Support your nation <strong>{{ session.nation }}</strong> for <strong>{{ current_month }}</strong>
        </p>

        <div class="mt-4 bg-slate-800/70 backdrop-blur-md border border-blue-400/30 rounded-xl p-6 max-w-md">
            <div class="flex items-center justify-between mb-4">
                <span class="text-blue-200 text-sm">Month</span>
                <span class="text-white font-bold">{{ current_month }}</span>
            </div>
            <div class="flex items-center justify-between mb-4">
                <span class="text-blue-200 text-sm">Amount</span>
                <span class="text-white font-bold text-2xl">â‚¹50</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-blue-200 text-sm">Payment Method</span>
                <span class="text-white text-sm">UPI (Google Pay / PhonePe / Paytm)</span>
            </div>
        </div>

        <div class="mt-8 w-full max-w-md space-y-4">
            <div class="bg-slate-800/70 p-6 rounded-xl flex flex-col items-center">
                <!-- QR Payment Section -->
                <img id="qrImage" src="{{ url_for('static', filename='payment/qr.png') }}" alt="UPI QR Code" class="w-48 h-48 rounded-md shadow-md mb-3 object-cover" />
                <p class="text-blue-200 text-sm mb-3">Scan this QR with any UPI app to send your contribution</p>

                <!-- Manual Verification Section (inline) -->
                <div class="w-full max-w-sm mt-4">
                    <div class="text-left text-sm text-blue-200 mb-2">Already paid? Enter your 12-digit UPI transaction ID below ðŸ‘‡</div>
                    <div class="flex gap-2">
                        <input id="txnIdInline" type="text" maxlength="20" placeholder="Enter Transaction ID" class="flex-1 p-2 rounded bg-slate-800 text-white" />
                        <button id="verifyInlineBtn" onclick="verifyTransactionInline()" class="px-4 py-2 rounded bg-primary text-white">Verify</button>
                    </div>
                    <div id="txnInlineStatus" class="mt-2 text-sm"></div>
                </div>

                <!-- Simple instruction animation: 3 steps -->
                <div class="mt-4 w-full text-left">
                    <style>
                        .pay-steps { display:flex; gap:8px; justify-content:space-between; }
                        .pay-step { flex:1; background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; color:#cfe8ff; font-size:13px; display:flex; gap:8px; align-items:center; opacity:0; transform:translateY(6px); }
                        .pay-step .num { background:rgba(255,255,255,0.04); width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:#fff; }
                        @keyframes stepFade { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
                        .pay-step.show { animation: stepFade 420ms ease forwards; }
                    </style>
                    <div class="pay-steps">
                        <div id="step1" class="pay-step">
                            <div class="num">1</div>
                            <div>
                                <div class="font-semibold">Scan QR</div>
                                <div class="text-xs text-blue-200">Open your UPI app and scan the code</div>
                            </div>
                        </div>
                        <div id="step2" class="pay-step">
                            <div class="num">2</div>
                            <div>
                                <div class="font-semibold">Confirm amount</div>
                                <div class="text-xs text-blue-200">Open your UPI app and scan the QR to pay â‚¹50</div>
                            </div>
                        </div>
                        <div id="step3" class="pay-step">
                            <div class="num">3</div>
                            <div>
                                <div class="font-semibold">Enter TXN</div>
                                <div class="text-xs text-blue-200">Paste the 12â€‘digit transaction id after payment</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Removed UPI app buttons: only QR code is used now -->
            <div class="flex items-center justify-center gap-6">
                <!-- space preserved for layout consistency -->
            </div>

            <a href="{{ url_for('dashboard') }}" onclick="showDashboardLoading();" class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-5 bg-slate-700/50 backdrop-blur-sm border border-blue-400/30 text-blue-200 hover:text-white text-base font-medium leading-normal tracking-[0.015em] no-underline transition-all dashboard-link">
                <span class="truncate">Cancel</span>
            </a>
        </div>

        <div class="mt-6 flex items-center gap-2 text-blue-200 text-xs">
            <span class="material-symbols-outlined text-sm">lock</span>
            <span>Secure payment via UPI app on your device</span>
        </div>
    </div>
    </div> <!-- Close content layer -->
</div>

<!-- UPI (Google Pay) flow -->
<script>
const currentMonth = "{{ current_month }}";

// Use local server-side wake endpoint so browser doesn't call the external webhook directly
const PAYMENT_WEBHOOK = '{{ url_for("wake_webhook") }}';

function showWebhookOverlay(msg) {
    // create or reuse an overlay element
    let el = document.getElementById('webhookOverlay');
    if (!el) {
        el = document.createElement('div');
        el.id = 'webhookOverlay';
        el.className = 'fixed inset-0 bg-black/72 z-50 flex items-center justify-center p-4';
        el.innerHTML = `
            <div class="text-center p-6 rounded-xl bg-slate-900/80 backdrop-blur-sm max-w-md w-full">
                <div class="mb-4 flex h-20 w-20 items-center justify-center mx-auto">
                    <!-- Removed rotating ring per request; keep a subtle pulsing icon -->
                    <span class="material-symbols-outlined text-4xl text-primary animate-pulse">cloud_sync</span>
                </div>
                <p id="webhookOverlayText" class="text-white text-lg font-semibold mb-2">${msg}</p>
                <p class="text-blue-300 text-sm">Waking payment servers â€” this may take 30â€“40 seconds.</p>
                <div class="mt-4">
                    <button id="webhookRetryBtn" class="mt-2 px-4 py-2 rounded bg-primary text-white">Retry</button>
                </div>
            </div>`;
        document.body.appendChild(el);
    } else {
        const t = document.getElementById('webhookOverlayText'); if (t) t.textContent = msg;
        el.classList.remove('hidden');
    }
}

function hideWebhookOverlay(){
    const el = document.getElementById('webhookOverlay');
    if (el) {
        try{ el.parentNode && el.parentNode.removeChild(el); }catch(e){}
    }
}

async function ensureWebhookUp(maxAttempts=5, perAttemptMs=50000){
    // Attempt to GET the webhook with a longer timeout suitable for cold-start wakeups.
    // Default: 5 attempts x 10s = up to ~50s total; adjust if needed.
    let attempt = 0;
    while(attempt < maxAttempts){
        attempt++;
        showWebhookOverlay('Checking payment servers (attempt ' + attempt + ' of ' + maxAttempts + ')');
        try{
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), perAttemptMs);
            const resp = await fetch(PAYMENT_WEBHOOK, { method: 'GET', cache: 'no-store', signal: controller.signal, mode: 'cors', headers: { 'Accept': 'application/json' } });
            clearTimeout(timeout);
            if (resp && resp.status === 200){
                hideWebhookOverlay();
                return true;
            }
        }catch(e){
            console.warn('ensureWebhookUp attempt failed:', e && e.name ? e.name : e);
        }
        // brief backoff before next attempt (capped)
        const backoff = 1000 * attempt; // 1s, 2s, 3s ...
        await new Promise(r => setTimeout(r, Math.min(backoff, 4000)));
    }
    // final failure: leave overlay with a retry button enabled. Make retry run a single immediate attempt.
    const retryBtn = document.getElementById('webhookRetryBtn');
    if (retryBtn) {
        retryBtn.onclick = async function(){
            try { retryBtn.disabled = true; } catch(e){}
            // run one attempt only with the same timeout
            showWebhookOverlay('Retrying payment server wake (single attempt)');
            let ok = false;
            try{
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), perAttemptMs);
                const resp = await fetch(PAYMENT_WEBHOOK, { method: 'GET', cache: 'no-store', signal: controller.signal, mode: 'cors', headers: { 'Accept': 'application/json' } });
                clearTimeout(timeout);
                ok = (resp && resp.status === 200);
            }catch(e){ console.warn('retry single attempt failed', e); }
            if(ok) hideWebhookOverlay();
            try { retryBtn.disabled = false; } catch(e){}
            return ok;
        };
    }
    return false;
}

// On page load, proactively ensure webhook is up before enabling Pay button
document.addEventListener('DOMContentLoaded', async function(){
    // Only enable the inline verification input/button once webhook health-check completes
    const verifyBtn = document.getElementById('verifyInlineBtn');
    try { if(verifyBtn) verifyBtn.disabled = true; } catch(e){}
    const ok = await ensureWebhookUp(5, 50000);
    if(ok){
        try { if(verifyBtn) verifyBtn.disabled = false; } catch(e){}
    } else {
        try { if(verifyBtn) verifyBtn.disabled = true; } catch(e){}
        alert('Payment servers could not be woken automatically. Press Retry in the overlay to try again.');
    }

    // Trigger small step animation for payment instructions
    try{
        const s1 = document.getElementById('step1');
        const s2 = document.getElementById('step2');
        const s3 = document.getElementById('step3');
        if(s1 && s2 && s3){
            setTimeout(()=>s1.classList.add('show'), 200);
            setTimeout(()=>s2.classList.add('show'), 500);
            setTimeout(()=>s3.classList.add('show'), 800);
        }
    }catch(e){}
});

// New helpers for QR + app button flow
function getUPIParams(){
    const pa = '{{ UPI_ID }}';
    const pn = '{{ session.get("username", "WC2026") }}';
    const am = '50';
    const cu = 'INR';
    const tn = 'WC2026 monthly payment for ' + currentMonth;
    return { pa, pn, am, cu, tn };
}

function buildUPIUrl(scheme, params){
    // scheme examples: 'upi://pay', 'tez://upi/pay', 'phonepe://pay', 'paytmmp://pay'
    const pa = encodeURIComponent(params.pa);
    const pn = encodeURIComponent(params.pn);
    const am = encodeURIComponent(params.am);
    const cu = encodeURIComponent(params.cu);
    const tn = encodeURIComponent(params.tn);
    return `${scheme}?pa=${pa}&pn=${pn}&am=${am}&cu=${cu}&tn=${tn}`;
}

async function openAppPay(app){
    // ensure webhook awake before attempting to open app
    const ok = await ensureWebhookUp(6, 50000);
    if(!ok){ alert('Payment servers unreachable. Please try again later.'); return; }
    const params = getUPIParams();
    let url = '';
    if(app === 'gpay'){
        url = buildUPIUrl('tez://upi/pay', params);
    } else if(app === 'phonepe'){
        url = buildUPIUrl('phonepe://pay', params);
    } else if(app === 'paytm'){
        url = buildUPIUrl('paytmmp://pay', params);
    }
    try{ window.location.href = url; } catch(e){ alert('Open your UPI app and pay to ' + params.pa); }
    // After opening app, focus the inline TXN input so users can paste the id when they return
    setTimeout(()=>{ try{ const inp = document.getElementById('txnIdInline'); if(inp){ inp.focus(); inp.scrollIntoView({behavior:'smooth', block:'center'}); } }catch(e){} }, 700);
}

function copyUPI(){
    const upi = '{{ UPI_ID }}';
    navigator.clipboard.writeText(upi).then(()=>{ alert('UPI ID copied to clipboard: ' + upi); }).catch(()=>{ prompt('Copy this UPI ID', upi); });
}

async function initiatePayment(){
    const button = document.getElementById('upiButton');
    const buttonText = document.getElementById('buttonText');
    button.disabled = true;
    buttonText.textContent = 'Preparing...';

    try{
        const resp = await fetch('{{ url_for("create_razorpay_order") }}', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ month: currentMonth })
        });
        const data = await resp.json();
        if(resp.ok && data.order_id){
            // Save flag so returning users show processing overlay
            try { sessionStorage.setItem('payment_checkout_opened', data.order_id); } catch(e){}
            // Ensure the payment webhook is awake before opening UPI
            const ok = await ensureWebhookUp(6, 50000);
            if(!ok){
                alert('Could not wake payment servers. Please try again in a moment.');
                try { sessionStorage.removeItem('payment_checkout_opened'); } catch(e){}
                return;
            }

            // Construct UPI URL and open app
            const pa = encodeURIComponent('{{ UPI_ID }}');
            const pn = encodeURIComponent('{{ session.get("username", "WC2026") }}');
            const am = '50';
            const cu = 'INR';
            const tn = encodeURIComponent('WC2026 monthly payment for ' + currentMonth);
            const upiUrl = `upi://pay?pa=${pa}&pn=${pn}&am=${am}&cu=${cu}&tn=${tn}`;

            try{ window.location.href = upiUrl; } catch(e){ alert('Please open your UPI app and pay to ' + decodeURIComponent(pa)); }

            // show modal after a short delay so user can enter txn id after paying
            setTimeout(()=>{
                try { button.disabled = false; buttonText.textContent = 'Pay â‚¹50 Now'; } catch(e){}
                const modal = document.getElementById('transactionModal');
                if(modal) modal.classList.remove('hidden');
            }, 800);
            return;
        } else {
            throw new Error(data.error || 'order_failed');
        }
    } catch(err){
        console.error('initiatePayment error', err);
        alert('Unable to start payment. Please try again.');
    } finally {
        try { button.disabled = false; buttonText.textContent = 'Pay â‚¹50 Now'; } catch(e){}
    }
}

// Inline verification (used in the new layout)
async function verifyTransactionInline(){
    const txnInput = document.getElementById('txnIdInline');
    const statusEl = document.getElementById('txnInlineStatus');
    if(!txnInput) return;
    const txnId = txnInput.value.trim();
    if(!txnId){ statusEl.innerHTML = '<span class="text-red-400">Please enter transaction id</span>'; return; }
    const btn = document.getElementById('verifyInlineBtn');
    btn.disabled = true; btn.innerText = 'Verifying...';
    try{
        const resp = await fetch('{{ url_for("verify_upi_transaction") }}', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ transaction_id: txnId }) });
        const data = await resp.json();
        if(data.status === 'ok'){
            statusEl.innerHTML = '<span class="text-green-400">Payment verified â€” redirecting...</span>';
            setTimeout(()=>{ window.location.href = '/payment-success'; }, 900);
        } else {
            statusEl.innerHTML = `<span class="text-red-400">${data.message || 'Not found'}</span>`;
        }
    }catch(err){
        statusEl.innerHTML = '<span class="text-red-400">Verification failed. Try again.</span>';
    } finally { btn.disabled = false; btn.innerText = 'Verify'; }
}
</script>

<!-- Inline verification replaces the modal -- kept removed -->
{% endblock %}