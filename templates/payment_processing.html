{% extends "base.html" %}

{% block title %}Payment Processing - World Cup Fan Zone{% endblock %}

{% block content %}
<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
    <!-- Immediate processing overlay if returning from Razorpay (run before heavy DOM paints) -->
    <script>
        (function(){
            try {
                var _rp_flag = null;
                try { _rp_flag = sessionStorage.getItem('razorpay_checkout_opened'); } catch(e) { _rp_flag = null; }
                if (_rp_flag && !document.getElementById('paymentProcessingOverlay')) {
                    var ol = document.createElement('div');
                    ol.id = 'paymentProcessingOverlay';
                    ol.className = 'rp-overlay';
                    ol.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
                    ol.innerHTML = '<div class="rp-card text-center rounded-lg p-4 bg-slate-900/70 backdrop-blur-sm">\n                            <div class="mb-4 flex h-20 w-20 items-center justify-center mx-auto">\n                                <div class="absolute inset-0 animate-spin rounded-full border-4 border-primary/30 border-t-primary"></div>\n                                <span class="material-symbols-outlined text-4xl text-primary animate-pulse">payments</span>\n                            </div>\n                            <p class="text-white text-lg font-semibold mb-1">Processing your payment...</p>\n                            <p class="text-blue-300 text-sm">Confirming with Razorpay — this should only take a moment.</p>\n                        </div>';
                        ol.innerHTML = '<div class="rp-card text-center rounded-lg p-4 bg-slate-900/70 backdrop-blur-sm">\n                            <div class="mb-4 flex h-20 w-20 items-center justify-center mx-auto">\n                                <span class="material-symbols-outlined text-4xl text-primary animate-pulse">payments</span>\n                            </div>\n                            <p class="text-white text-lg font-semibold mb-1">Processing your payment...</p>\n                            <p class="text-blue-300 text-sm">Confirming with Razorpay — this should only take a moment.</p>\n                        </div>';
                    try { document.documentElement.appendChild(ol); } catch(e) { try { document.body.appendChild(ol); } catch(e) {} }
                    setTimeout(function(){ try{ ol.classList.add('rp-visible'); }catch(e){} }, 20);
                }
            } catch(e) { /* silent */ }
        })();
    </script>

    <!-- Video Background -->
    <video autoplay loop muted playsinline preload="none" class="fixed top-0 left-0 w-full h-full object-cover z-0 opacity-15">
        <source src="https://cdn.jsdelivr.net/gh/NivedKris/cdn@main/background.mp4" type="video/mp4">
        <source src="{{ url_for('static', filename='video/background.mp4') }}" type="video/mp4">
    </video>

    <!-- Content Layer -->
    <div class="relative z-10">
    <div class="flex items-center bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm p-4 pb-2 justify-between">
        <a href="{{ url_for('dashboard') }}" class="text-slate-800 dark:text-white flex size-12 shrink-0 items-center">
            <span class="material-symbols-outlined text-2xl">arrow_back</span>
        </a>
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Complete Payment</h2>
        <div class="size-12 shrink-0"></div>
    </div>

    <div class="flex flex-col items-center justify-center flex-1 px-4 py-8 text-center">
        <div class="relative mb-8 flex h-40 w-40 items-center justify-center bg-primary/10 rounded-full">
            <span class="material-symbols-outlined text-7xl text-primary">payments</span>
        </div>
        
        <h1 class="text-white tracking-light text-[32px] font-bold leading-tight pb-3 pt-6">Pay with Razorpay</h1>
        
        <p class="text-blue-200 text-base font-normal leading-normal pb-3 pt-1 max-w-md">
            Support your nation <strong>{{ session.nation }}</strong> for <strong>{{ current_month }}</strong>
        </p>

        <div class="mt-4 bg-slate-800/70 backdrop-blur-md border border-blue-400/30 rounded-xl p-6 max-w-md">
            <div class="flex items-center justify-between mb-4">
                <span class="text-blue-200 text-sm">Month</span>
                <span class="text-white font-bold">{{ current_month }}</span>
            </div>
            <div class="flex items-center justify-between mb-4">
                <span class="text-blue-200 text-sm">Amount</span>
                <span class="text-white font-bold text-2xl">₹50</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-blue-200 text-sm">Payment Method</span>
                <span class="text-white text-sm">Razorpay (Card/UPI/Netbanking)</span>
            </div>
        </div>

        <div class="mt-8 w-full max-w-sm space-y-3">
            <button id="razorpayButton" onclick="initiatePayment()" class="flex w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-xl h-14 px-5 bg-primary hover:bg-primary/90 text-white text-base font-bold leading-normal tracking-[0.015em] transition-all">
                <span class="material-symbols-outlined">credit_card</span>
                <span id="buttonText">Pay ₹50 Now</span>
            </button>
            
            <a href="{{ url_for('dashboard') }}" onclick="showDashboardLoading();" class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-5 bg-slate-700/50 backdrop-blur-sm border border-blue-400/30 text-blue-200 hover:text-white text-base font-medium leading-normal tracking-[0.015em] no-underline transition-all dashboard-link">
                <span class="truncate">Cancel</span>
            </a>
        </div>

        <div class="mt-6 flex items-center gap-2 text-blue-200 text-xs">
            <span class="material-symbols-outlined text-sm">lock</span>
            <span>Secure payment powered by Razorpay</span>
        </div>
    </div>
    </div> <!-- Close content layer -->
</div>

<!-- Razorpay Checkout Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const currentMonth = "{{ current_month }}";

function initiatePayment() {
    const button = document.getElementById('razorpayButton');
    const buttonText = document.getElementById('buttonText');
    
    // Disable button and show loading
    button.disabled = true;
    buttonText.textContent = 'Creating order...';
    
    // Step 1: Create Razorpay order
    fetch('/create-razorpay-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            month: currentMonth
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create order');
        }
        return response.json();
    })
    .then(order => {
        // Step 2: Configure Razorpay options
        const options = {
            "key": order.key_id,
            "amount": order.amount,
            "currency": order.currency,
            "name": "WC 2026 Fan Zone",
            "description": "Monthly Support for " + currentMonth,
            "order_id": order.order_id,
            // use handler mode to verify via AJAX and avoid a server redirect flash
            "handler": function (response){
                try { sessionStorage.setItem('razorpay_checkout_opened', order.order_id || '1'); } catch (e) {}
                // show immediate overlay
                try {
                    var overlay = document.getElementById('paymentProcessingOverlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.id = 'paymentProcessingOverlay';
                        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);z-index:99999;display:flex;align-items:center;justify-content:center;';
                        overlay.innerHTML = '<div class="text-center"><div class="mb-4 flex h-28 w-28 items-center justify-center mx-auto"><div class="absolute inset-0 animate-spin rounded-full border-4 border-primary/30 border-t-primary"></div><span class="material-symbols-outlined text-5xl text-primary animate-pulse">payments</span></div><p class="text-white text-xl font-bold mb-2">Processing your payment...</p><p class="text-blue-300 text-sm">Please wait while we confirm your payment with Razorpay.</p></div>';
                            overlay.innerHTML = '<div class="text-center"><div class="mb-4 flex h-28 w-28 items-center justify-center mx-auto"><span class="material-symbols-outlined text-5xl text-primary animate-pulse">payments</span></div><p class="text-white text-xl font-bold mb-2">Processing your payment...</p><p class="text-blue-300 text-sm">Please wait while we confirm your payment with Razorpay.</p></div>';
                        try { document.documentElement.appendChild(overlay); } catch(e) { document.body.appendChild(overlay); }
                    }
                } catch(e){}

                // Send verification to server via AJAX
                fetch('/verify-razorpay-payment-ajax', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    })
                }).then(r => r.json()).then(json => {
                    // clear local flag
                    try { sessionStorage.removeItem('razorpay_checkout_opened'); } catch(e) {}
                    if (json && json.status === 'ok') {
                        window.location.href = '/payment-success';
                    } else {
                        window.location.href = '/payment-failed';
                    }
                }).catch(err => {
                    console.error('AJAX verify error', err);
                    window.location.href = '/payment-failed';
                });
            },
            "prefill": {
                "name": "{{ session.username }}",
                "email": "{{ session.get('email', '') }}"
            },
            "theme": {
                "color": "#1e40af"
            },
            "modal": {
                "ondismiss": function() {
                    // Re-enable button if user closes modal
                    button.disabled = false;
                    buttonText.textContent = 'Pay ₹50 Now';
                    try { sessionStorage.removeItem('razorpay_checkout_opened'); } catch (e) {}
                }
            }
        };
        
        // Step 3: Open Razorpay Checkout
        const rzp = new Razorpay(options);
            // Mark that checkout was opened so returning users show processing immediately
            try { sessionStorage.setItem('razorpay_checkout_opened', order.order_id || '1'); } catch (e) {}
        rzp.open();
        
        // Re-enable button after opening
        button.disabled = false;
        buttonText.textContent = 'Pay ₹50 Now';
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Failed to create payment order. Please try again.');
        button.disabled = false;
        buttonText.textContent = 'Pay ₹50 Now';
    });
}
</script>
    <script>
    // If the user returns to this page after opening Razorpay, show immediate processing overlay
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const flag = sessionStorage.getItem('razorpay_checkout_opened');
            if (flag) {
                // show processing overlay and disable UI so user sees immediate feedback
                const btn = document.getElementById('razorpayButton');
                if (btn) {
                    btn.disabled = true;
                    const btText = document.getElementById('buttonText');
                    if (btText) btText.textContent = 'Processing payment...';
                }
                // create overlay
                const overlay = document.createElement('div');
                overlay.id = 'paymentProcessingOverlay';
                overlay.className = 'rp-overlay';
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.72);backdrop-filter:blur(6px);z-index:99999;display:flex;align-items:center;justify-content:center;padding:18px;';
                overlay.innerHTML = `
                    <div class="rp-card text-center rounded-lg p-4 bg-slate-900/70 backdrop-blur-sm">
                        <div class="mb-4 flex h-20 w-20 items-center justify-center mx-auto">
                            <span class="material-symbols-outlined text-4xl text-primary animate-pulse">payments</span>
                        </div>
                        <p class="text-white text-lg font-semibold mb-1">Processing your payment...</p>
                        <p class="text-blue-300 text-sm">Confirming with Razorpay — this should only take a moment.</p>
                    </div>
                `;
                document.body.appendChild(overlay);
                setTimeout(function(){ try{ overlay.classList.add('rp-visible'); }catch(e){} }, 20);
            }
        } catch (e) {
            console.warn('Could not read razorpay flag', e);
        }
    });
    </script>
{% endblock %}